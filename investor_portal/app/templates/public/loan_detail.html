<!-- templates/public/loan_detail.html -->
{% extends "app/base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-2">
    <h2>{{ loan.loan_id }} ‚Äî {{ loan.title }}</h2>
    <a href="{% url 'rwa:loans_list' %}" class="btn btn-sm btn-outline-secondary">‚Üê Back to Market</a>
</div>

<hr>

<div class="row">
    <div class="col-md-7">
        <div class="card border-0 shadow-sm p-4 mb-4">
            <h4>Loan Terms</h4>
            <div class="row mt-3">
                <div class="col-6 mb-3">
                    <label class="text-muted small d-block">BORROWER</label>
                    <strong>{{ loan.borrower }}</strong>
                </div>
                <div class="col-6 mb-3">
                    <label class="text-muted small d-block">PRINCIPAL</label>
                    <strong>${{ loan.principal }}</strong>
                </div>
                <div class="col-6 mb-3">
                    <label class="text-muted small d-block">ANNUAL INTEREST</label>
                    <strong class="text-success">{{ loan.annual_interest_rate }}%</strong>
                </div>
                <div class="col-6 mb-3">
                    <label class="text-muted small d-block">EST. MONTHLY INTEREST (ACCRUED)</label>
                    <strong>${{ loan.monthly_interest }}</strong>
                </div>
            </div>
            <hr>
            <h4>Note Structure</h4>
            <p class="mb-0">
                <strong>Total Slices:</strong> {{ loan.total_slices }}<br>
                <strong>Unit Price:</strong> ${{ loan.unit_price_usdc }} per slice
            </p>
        </div>
    </div>

    <div class="col-md-5">
        <div class="card border-0 shadow-sm p-4 bg-dark text-white h-100">
            <h4 class="text-info">Security Audit</h4>
            
            {% if loan.tokenized %}
                <div id="audit-loading" class="text-center py-4">
                    <div class="spinner-border text-info" role="status"></div>
                    <p class="mt-2 small text-info">Querying IPFS & Blockchain Anchor...</p>
                </div>

                <div id="audit-result" style="display: none;">
                    {% if is_verified %}
                        <div class="alert alert-success border-0 bg-success-soft py-3 text-center">
                            <h2 class="mb-0">üõ°Ô∏è</h2>
                            <strong class="d-block">VERIFIED INTEGRITY</strong>
                            <code class="small text-dark">{{ loan.metadata_hash|truncatechars:18 }}</code>
                        </div>
                    {% else %}
                        <div class="alert alert-danger border-0 py-3 text-center pulse-animation">
                            <h2 class="mb-0">‚ö†Ô∏è</h2>
                            <strong class="d-block">INTEGRITY BREACH</strong>
                            <small>Fingerprint Mismatch Detected</small>
                        </div>
                    {% endif %}
                    
                    <div class="mt-3 small">
                        <label class="text-muted d-block">CONTRACT ADDRESS</label>
                        <a href="https://testnet.snowtrace.io/address/{{ loan.token_contract }}" target="_blank" class="text-info text-break font-monospace">
                            {{ loan.token_contract }}
                        </a>
                        <label class="text-muted d-block mt-2">TOKEN ID</label>
                        <span class="font-monospace">{{ loan.token_id }}</span>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-secondary text-center py-4">
                    <p class="mb-0">Asset Not Yet Tokenized</p>
                    <small>Integrity verification unavailable</small>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<hr class="my-5">

<h4>Disclosures</h4>
<p class="text-muted small">
    This cryptographic verification ensures that the loan terms displayed in this database match the immutable 
    fingerprint anchored on the Avalanche network. Tampering with any field (Principal, APR, Term) will 
    immediately invalidate the On-Chain Security Audit.
</p>

<style>
    .pulse-animation {
        animation: pulse-red 2s infinite;
        border: 2px solid #ff4d4d !important;
    }
    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(255, 77, 77, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); }
    }
    .bg-success-soft { background-color: #d1e7dd; color: #0f5132; }
</style>

<script>
    // Simulate the audit time for better UX impact
    setTimeout(function() {
        document.getElementById('audit-loading').style.display = 'none';
        document.getElementById('audit-result').style.display = 'block';
    }, 1200);
</script>

{% endblock %}
